# ============================================
# AskValentin Core Project
# Domain: askvalentin.duckdns.org / chatp2.duckdns.org
# Port: 443 (Standard HTTPS)
# ============================================

# Rate Limiting
limit_req_zone $binary_remote_addr zone=askvalentin_api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=askvalentin_chat:10m rate=5r/s;

# Upstream Definitions
upstream askvalentin_app_backend {
    server askvalentin-app:8000 max_fails=3 fail_timeout=30s;
}

upstream askvalentin_monitor_backend {
    server askvalentin-monitor:5050 max_fails=3 fail_timeout=30s;
}

upstream askvalentin_grafana_backend {
    server askvalentin-grafana:3000 max_fails=3 fail_timeout=30s;
}

upstream askvalentin_prometheus_backend {
    server askvalentin-prometheus:9090 max_fails=3 fail_timeout=30s;
}

# ============================================
# HTTP → HTTPS Redirect
# ============================================
server {
    listen 80;
    server_name askvalentin.duckdns.org chatp2.duckdns.org;

    # ACME Challenge für Let's Encrypt
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Alles andere → HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# ============================================
# HTTPS Server - AskValentin Core
# ============================================
server {
    listen 443 ssl;
    http2 on;
    server_name askvalentin.duckdns.org chatp2.duckdns.org;

    # SSL Zertifikate
    ssl_certificate /etc/letsencrypt/live/chatp2.duckdns.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/chatp2.duckdns.org/privkey.pem;
    
    # SSL Best Practices
    include /etc/nginx/ssl/options-ssl-nginx.conf;
    ssl_dhparam /etc/nginx/ssl/ssl-dhparams.pem;

    # Security Headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # ========================================
    # Main App
    # ========================================
    location / {
        proxy_pass http://askvalentin_app_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Rate Limiting
        limit_req zone=askvalentin_chat burst=10 nodelay;
        
        # Timeouts für LLM Streaming
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
        proxy_send_timeout 300s;
    }

    # ========================================
    # Monitor Dashboard
    # ========================================
    location /monitor {
        proxy_pass http://askvalentin_monitor_backend/monitor;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ========================================
    # Grafana
    # ========================================
    location /grafana/ {
        proxy_pass http://askvalentin_grafana_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # WebSocket Support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ========================================
    # Prometheus
    # ========================================
    location /prometheus/ {
        proxy_pass http://askvalentin_prometheus_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ========================================
    # Health Check
    # ========================================
    location /health {
        proxy_pass http://askvalentin_app_backend/health;
        access_log off;
    }
}
